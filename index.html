<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>aprovaobras · Configurar & Login</title>
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;background:#0b1020;color:#e8eeff}
    .wrap{max-width:1100px;margin:0 auto;padding:20px 16px}
    .card{background:#11162d;border:1px solid #1e2547;border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    h3{margin:0 0 10px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    input,button{border-radius:12px;border:1px solid #2a3569;background:#0d1430;color:#e8eeff;padding:10px 12px}
    input{min-width:240px}
    button{cursor:pointer}
    .primary{background:#6aa1ff;border-color:#2a62ff;color:#071226;font-weight:600}
    .status{font-size:.95rem}
    .ok{color:#36d399}.warn{color:#fbbd23}.err{color:#f87272}
    .note{color:#8ea0c6;font-size:.9rem}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h3>1) Configurar Supabase</h3>
      <div class="note">Cole sua <b>SUPABASE_URL</b> (ex: https://xxxxx.supabase.co) e <b>ANON KEY</b>.</div>
      <div class="row" style="margin-top:10px">
        <input id="inpUrl" placeholder="https://xxxxx.supabase.co">
        <input id="inpKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        <button id="btnConnect" class="primary">Conectar</button>
      </div>
      <div style="margin-top:8px">Status: <span id="connStatus" class="status warn">Aguardando...</span></div>
    </div>
  </div>

  <!-- Supabase UMD bundle (sem type=module) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.1/dist/umd/supabase.js" defer></script>

  <script defer>
    const K_URL = 'SUPA_URL';
    const K_KEY = 'SUPA_KEY';

    const inpUrl = document.querySelector('#inpUrl');
    const inpKey = document.querySelector('#inpKey');
    const btnConnect = document.querySelector('#btnConnect');
    const connStatus = document.querySelector('#connStatus');

    let sb = null;

    function setStatus(msg, cls='warn'){
      connStatus.textContent = msg;
      connStatus.className = 'status ' + cls;
      console.log('[status]', msg);
    }

    function saveCfg(url, key){
      localStorage.setItem(K_URL, url);
      localStorage.setItem(K_KEY, key);
    }
    function restoreCfg(){
      const url = localStorage.getItem(K_URL);
      const key = localStorage.getItem(K_KEY);
      if (url) inpUrl.value = url;
      if (key) inpKey.value = key;
    }

    window.addEventListener('DOMContentLoaded', () => {
      restoreCfg();

      btnConnect.addEventListener('click', async () => {
        const url = (inpUrl.value || '').trim();
        const key = (inpKey.value || '').trim();
        if (!url || !key){ setStatus('Preencha URL e KEY', 'err'); return; }
        if (url.includes('.storage.')){ setStatus('Use a URL do PROJETO (https://xxxxx.supabase.co), não a do Storage.', 'err'); return; }

        try {
          const { createClient } = window.supabase;   // vem do bundle UMD
          sb = createClient(url, key);

          // teste rápido de conexão/permite SELECT
          const { data, error } = await sb.from('profiles').select('id').limit(1);
          if (error) setStatus('Conectado (client OK). Teste: ' + error.message, 'ok');
          else setStatus('Conectado (client OK).', 'ok');

          saveCfg(url, key);
        } catch (err) {
          setStatus('Erro: ' + (err?.message || String(err)), 'err');
          console.error(err);
        }
      });
    });
  </script>
</body>
</html>
